(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[964],{4830:function(e,s,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin",function(){return r(3626)}])},3626:function(e,s,r){"use strict";r.r(s),r.d(s,{default:function(){return AdminIndex}});var t=r(5893),a=r(7294),n=r(8675),i=r(5710);let l="qanari:alerts";function load(){try{let e=localStorage.getItem(l);return e?JSON.parse(e):[]}catch(e){return[]}}function save(e){localStorage.setItem(l,JSON.stringify(e));try{window.dispatchEvent(new CustomEvent("qanari:alerts-updated"))}catch(e){}}function listAlerts(){return load().sort((e,s)=>s.ts-e.ts)}var d=r(158),c=r(1163);function BarChart(e){let{data:s,width:r=300,height:a=120}=e,n=Math.max(...s,1),i=Math.floor(r/s.length);return(0,t.jsx)("svg",{width:r,height:a,className:"block",children:s.map((e,s)=>{let r=Math.round(e/n*(a-20)),l=s*i+4;return(0,t.jsx)("rect",{x:l,y:a-r-10,width:i-6,height:r,fill:"#60a5fa"},s)})})}function LineChart(e){let{data:s,width:r=300,height:a=120}=e,n=Math.max(...s,1),i=r/Math.max(s.length-1,1),l=s.map((e,s)=>"".concat(s*i,",").concat(a-Math.round(e/n*(a-20))-10));return(0,t.jsxs)("svg",{width:r,height:a,className:"block",children:[(0,t.jsx)("polyline",{points:l.join(" "),fill:"none",stroke:"#34d399",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"}),s.map((e,s)=>{let r=s*i,l=a-Math.round(e/n*(a-20))-10;return(0,t.jsx)("circle",{cx:r,cy:l,r:3,fill:"#10b981"},s)})]})}function AdminIndex(){let[e,s]=(0,a.useState)(null),[l,o]=(0,a.useState)(null),[h,m]=(0,a.useState)(!1),[x,u]=(0,a.useState)(null),[p,j]=(0,a.useState)("week"),[g,N]=(0,a.useState)([]),b=(0,c.useRouter)();(0,a.useEffect)(()=>{s((0,i.getMetrics)()),o((0,i.seriesLastNDays)(7)),N(listAlerts())},[]);let reprocess=()=>{u(null),m(!0);try{let e=(0,d.reprocessPaidOrdersForMetrics)();s((0,i.getMetrics)()),o((0,i.seriesLastNDays)(7)),e&&e.processed?u("پردازش سفارش‌های پرداخت‌شده انجام شد"):u("هیچ سفارشی برای پردازش وجود نداشت یا خطا رخ داد")}catch(e){u("خطا هنگام پردازش: "+String(e))}m(!1)},refreshSeriesForPeriod=e=>{j(e),"day"===e?o((0,i.seriesLastNDays)(7)):"week"===e?o((0,i.seriesLastNWeeks)(4)):"month"===e?o((0,i.seriesLastNMonths)(6)):o((0,i.seriesLastNYears)(5))};return(0,t.jsx)(n.Z,{children:(0,t.jsxs)("div",{children:[(0,t.jsx)("h1",{className:"text-2xl font-bold mb-4",children:"پیشخوان"}),(0,t.jsxs)("div",{className:"flex items-center gap-2 mb-4",children:[(0,t.jsx)("button",{className:"px-3 py-1 border rounded",onClick:reprocess,disabled:h,children:h?"در حال پردازش…":"پردازش سفارش‌های پرداخت‌شده"}),(0,t.jsx)("button",{className:"px-3 py-1 border rounded ml-2",onClick:()=>b.push("/admin/gamification"),children:"گیمیفیکیشن"})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2 mb-4",children:[(0,t.jsx)("button",{className:"px-3 py-1 border rounded",onClick:reprocess,disabled:h,children:h?"در حال پردازش…":"پردازش سفارش‌های پرداخت‌شده"}),(0,t.jsx)("button",{className:"px-3 py-1 border rounded",onClick:()=>{u(null),m(!0);try{let e=r(5710),t="function"==typeof e.recomputeMetricsFromOrders?e.recomputeMetricsFromOrders():null;s((0,i.getMetrics)()),o((0,i.seriesLastNDays)(7)),t&&t.rebuilt?u("بازسازی متریک‌ها انجام شد"):u("بازسازی انجام نشد یا خطا رخ داد")}catch(e){u("خطا هنگام بازسازی: "+String(e))}m(!1)},disabled:h,children:h?"در حال پردازش…":"بازسازی متریک از سفارش‌ها"}),x?(0,t.jsx)("div",{className:"text-sm text-gray-700",children:x}):null,(0,t.jsxs)("div",{className:"ml-auto flex items-center gap-2",children:[(0,t.jsx)("div",{className:"text-sm",children:"دوره:"}),(0,t.jsx)("button",{className:"px-2 py-1 border rounded ".concat("day"===p?"bg-gray-200":""),onClick:()=>refreshSeriesForPeriod("day"),children:"روز"}),(0,t.jsx)("button",{className:"px-2 py-1 border rounded ".concat("week"===p?"bg-gray-200":""),onClick:()=>refreshSeriesForPeriod("week"),children:"هفته"}),(0,t.jsx)("button",{className:"px-2 py-1 border rounded ".concat("month"===p?"bg-gray-200":""),onClick:()=>refreshSeriesForPeriod("month"),children:"ماه"}),(0,t.jsx)("button",{className:"px-2 py-1 border rounded ".concat("year"===p?"bg-gray-200":""),onClick:()=>refreshSeriesForPeriod("year"),children:"سال"})]})]}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[(0,t.jsxs)("div",{className:"neo-card p-4",children:["تعداد کاربران: ",(0,t.jsx)("strong",{children:e?e.users:"—"})]}),(0,t.jsxs)("div",{className:"neo-card p-4",children:["بازدید امروز: ",(0,t.jsx)("strong",{children:e?e.viewsToday:"—"})]}),(0,t.jsxs)("div",{className:"neo-card p-4",children:["فروش این هفته: ",(0,t.jsx)("strong",{children:e&&"number"==typeof e.salesThisWeek?e.salesThisWeek.toLocaleString():"—"})]}),(0,t.jsxs)("div",{className:"neo-card p-4",children:["کل بازدید ثبت‌شده: ",(0,t.jsx)("strong",{children:e?(e.viewEvents||[]).length:"—"})]})]}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{className:"neo-card p-4",children:[(0,t.jsx)("h3",{className:"font-semibold mb-2",children:"بازدید (7 روز اخیر)"}),l?(0,t.jsx)(BarChart,{data:l.views,width:360,height:140}):(0,t.jsx)("div",{children:"درحال بارگذاری…"}),(0,t.jsx)("div",{className:"text-sm text-gray-600 mt-2",children:"روزها از چپ (قدیمی) به راست (جدید)"})]}),(0,t.jsxs)("div",{className:"neo-card p-4",children:[(0,t.jsx)("h3",{className:"font-semibold mb-2",children:"فروش (7 روز اخیر)"}),l?(0,t.jsx)(LineChart,{data:l.sales,width:360,height:140}):(0,t.jsx)("div",{children:"درحال بارگذاری…"}),(0,t.jsx)("div",{className:"text-sm text-gray-600 mt-2",children:"مبلغ فروش به تومان"})]})]}),(0,t.jsxs)("div",{className:"mt-6",children:[(0,t.jsx)("h3",{className:"font-semibold mb-2",children:"اعلان‌ها"}),(0,t.jsxs)("div",{className:"neo-card p-4",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 mb-3",children:[(0,t.jsx)("button",{className:"px-2 py-1 border rounded",onClick:()=>{!function(e,s){let r=load(),t={id:"a_".concat(Date.now()),ts:Date.now(),level:e,message:s};r.unshift(t),save(r)}("warning","آزمون: رویداد هشدار جدید"),N(listAlerts())},children:"افزودن اعلان تست"}),(0,t.jsx)("button",{className:"px-2 py-1 border rounded",onClick:()=>{save([]),N([])},children:"پاک کردن اعلان‌ها"})]}),0===g.length?(0,t.jsx)("div",{className:"text-sm text-gray-600",children:"اعنانی وجود ندارد"}):(0,t.jsx)("ul",{className:"space-y-2",children:g.map(e=>(0,t.jsxs)("li",{className:"p-2 border rounded flex justify-between items-center",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("div",{className:"font-medium",children:e.level.toUpperCase()}),(0,t.jsx)("div",{className:"text-sm",children:e.message}),(0,t.jsx)("div",{className:"text-xs text-gray-500",children:new Date(e.ts).toLocaleString()})]}),(0,t.jsx)("div",{children:e.read?"خوانده شده":"جدید"})]},e.id))})]})]}),(0,t.jsx)("div",{className:"mt-6",children:(0,t.jsx)("button",{className:"px-4 py-2 bg-blue-500 text-white rounded",onClick:()=>b.push("/admin/blog"),children:"مدیریت مطالب وبلاگ"})})]})})}}},function(e){e.O(0,[424,675,774,888,179],function(){return e(e.s=4830)}),_N_E=e.O()}]);