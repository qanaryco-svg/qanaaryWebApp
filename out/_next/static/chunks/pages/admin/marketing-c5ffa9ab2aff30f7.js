(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[556],{6823:function(e,r,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/marketing",function(){return t(8834)}])},8834:function(e,r,t){"use strict";t.r(r),t.d(r,{default:function(){return AdminMarketing}});var d=t(5893),a=t(7294),s=t(8675);function AdminMarketing(){let[e,r]=(0,a.useState)([]),[n,i]=(0,a.useState)([]),[l,c]=(0,a.useState)(null),[o,m]=(0,a.useState)(!1);(0,a.useEffect)(()=>{let loadAll=()=>{try{let e=t(4702),d=t(158);r(e.buildReferralTree()),i(d.loadOrders()),c(e.loadMembers())}catch(e){r([]),i([]),c([])}};loadAll();let onUpdate=()=>loadAll();try{window.addEventListener("qanari:orders-updated",onUpdate),window.addEventListener("qanari:members-updated",onUpdate);try{if(window.BroadcastChannel){let e=new BroadcastChannel("qanari:orders");e.onmessage=onUpdate;let r=new BroadcastChannel("qanari:members");r.onmessage=onUpdate,window.__qanari_bc_orders=e,window.__qanari_bc_members=r}}catch(e){}}catch(e){}return()=>{try{window.removeEventListener("qanari:orders-updated",onUpdate),window.removeEventListener("qanari:members-updated",onUpdate);try{let e=window.__qanari_bc_orders,r=window.__qanari_bc_members;e&&e.close(),r&&r.close(),delete window.__qanari_bc_orders,delete window.__qanari_bc_members}catch(e){}}catch(e){}}},[]);let Node=e=>{let{node:r,depth:t=0}=e,[s,i]=(0,a.useState)(t<1),c=0,o=r.member.commissionEarned||0;try{let e=n.filter(e=>e.referrerId===r.member.id&&"paid"===e.status);c=e.reduce((e,r)=>e+(r.total||0),0);let t=(l||[]).find(e=>e.id===r.member.id);t&&(o=t.commissionEarned||0)}catch(e){}return(0,d.jsxs)("div",{className:"pl-",style:{paddingLeft:16*t},children:[(0,d.jsxs)("div",{className:"p-2 border rounded mb-2 bg-white flex items-center justify-between",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("button",{onClick:()=>i(!s),className:"mr-2 px-2 py-1 border rounded text-sm",children:s?"-":"+"}),(0,d.jsx)("span",{className:"font-semibold",children:r.member.name||r.member.email}),(0,d.jsxs)("div",{className:"text-xs text-gray-600",children:["کد: ",r.member.referralCode||"—"]})]}),(0,d.jsxs)("div",{className:"text-right text-sm",children:[(0,d.jsxs)("div",{children:["سود: ",(0,d.jsx)("strong",{children:(o||0).toLocaleString()})]}),(0,d.jsxs)("div",{children:["مبلغ ارجاع: ",(0,d.jsx)("strong",{children:c.toLocaleString()})]})]})]}),s&&r.children&&r.children.length>0&&(0,d.jsx)("div",{className:"ml-4",children:r.children.map(e=>(0,d.jsx)(Node,{node:e,depth:t+1},e.member.id))})]})};return(0,d.jsx)(s.Z,{children:(0,d.jsxs)("div",{children:[(0,d.jsx)("h1",{className:"text-2xl font-bold mb-4",children:"فروش و بازاریابی — درخت معرف‌ها"}),(0,d.jsx)("p",{className:"text-sm text-gray-600 mb-4",children:"نمایش سلسله‌مراتبی اعضا و شبکه معرف‌ها (چندسطحی)."}),(0,d.jsxs)("div",{className:"mb-4 flex items-center gap-3",children:[(0,d.jsx)("button",{onClick:()=>{try{let e=t(4702),d=t(158);r(e.buildReferralTree()),i(d.loadOrders())}catch(e){}},className:"px-3 py-2 border rounded",children:"بارگذاری مجدد"}),(0,d.jsx)("div",{className:"text-sm text-gray-500",children:"(برای اطمینان از تازه‌سازی دستی)"})]}),(0,d.jsx)("div",{className:"space-y-3",children:e.map(e=>(0,d.jsx)(Node,{node:e,depth:0},e.member.id))}),(0,d.jsxs)("div",{className:"mt-6 p-3 border rounded",children:[(0,d.jsx)("h3",{className:"font-semibold mb-2",children:"پرداخت‌های بدون معرف (اختیاری)"}),(0,d.jsx)("p",{className:"text-sm text-gray-600 mb-2",children:"برای هر سفارش پرداخت‌شده که معرف ندارد، یک معرف انتخاب کنید تا سود محاسبه و ثبت شود."}),(()=>{try{let e=n.filter(e=>"paid"===e.status&&!e.referrerId),a=l||[];if(0===e.length)return(0,d.jsx)("div",{className:"text-sm text-gray-600",children:"سفارشی یافت نشد."});return(0,d.jsx)("div",{className:"space-y-3",children:e.map(e=>(0,d.jsxs)("div",{className:"flex items-center gap-3",children:[(0,d.jsx)("div",{className:"flex-1",children:(0,d.jsxs)("div",{className:"text-sm",children:["#",e.id," — مبلغ: ",e.total.toLocaleString()," تومان — خریدار: ",e.memberEmail||"مهمان"]})}),(0,d.jsx)("div",{children:(0,d.jsxs)("select",{id:"sel-".concat(e.id),className:"border p-1 rounded",children:[(0,d.jsx)("option",{value:"",children:"انتخاب معرف..."}),a.map(e=>(0,d.jsx)("option",{value:e.id,children:e.name||e.email},e.id))]})}),(0,d.jsx)("div",{children:(0,d.jsx)("button",{className:"px-3 py-1 bg-qanari text-qanariDark rounded",onClick:()=>{try{let d=document.getElementById("sel-".concat(e.id)),a=d?d.value:"";if(!a)return alert("لطفا معرف را انتخاب کنید");let s=t(158),n=t(4702),l=s.loadOrders(),o=l.findIndex(r=>r.id===e.id);if(-1===o)return alert("سفارش پیدا نشد");let m=Math.round(5*l[o].total/100);"function"==typeof n.distributeCommissionUpchain?n.distributeCommissionUpchain(a,m):n.creditCommission(a,m),l[o].referrerId=a,s.saveOrders(l);try{window.dispatchEvent(new CustomEvent("qanari:members-updated"))}catch(e){}try{window.dispatchEvent(new CustomEvent("qanari:orders-updated"))}catch(e){}alert("معرف ثبت و سود اعمال شد"),i(s.loadOrders()),c(n.loadMembers()),r(n.buildReferralTree())}catch(e){console.error(e),alert("خطا در اعمال")}},children:"ثبت و اعمال"})})]},e.id))})}catch(e){return(0,d.jsx)("div",{className:"text-sm text-red-500",children:"خطا در بارگذاری سفارش‌ها"})}})()]})]})})}}},function(e){e.O(0,[424,675,774,888,179],function(){return e(e.s=6823)}),_N_E=e.O()}]);