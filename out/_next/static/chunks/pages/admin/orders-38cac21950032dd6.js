(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[426],{2479:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/orders",function(){return s(178)}])},178:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return AdminOrders}});var l=s(5893),a=s(7294),r=s(8675),d=s(158),n=s(2929),i=s(8120),c=s(3293);function AdminOrders(){let[e,t]=(0,a.useState)([]),[s,o]=(0,a.useState)([]),[x,h]=(0,a.useState)(""),[m,u]=(0,a.useState)("all"),[p,g]=(0,a.useState)("all"),[j,v]=(0,a.useState)("date"),[N,w]=(0,a.useState)("desc"),[b,f]=(0,a.useState)(null),[y,S]=(0,a.useState)(new Set),{lang:C}=(0,c.Z)();(0,a.useEffect)(()=>{let e=(0,d.loadOrders)();t(e),o((0,n.QD)());let handleUpdate=()=>{t((0,d.loadOrders)())};return window.addEventListener("qanari:orders-updated",handleUpdate),()=>window.removeEventListener("qanari:orders-updated",handleUpdate)},[]);let getDateRangeStart=e=>{let t=new Date;switch(e){case"today":return new Date(t.getFullYear(),t.getMonth(),t.getDate()).getTime();case"week":return new Date(t.getFullYear(),t.getMonth(),t.getDate()-7).getTime();case"month":return new Date(t.getFullYear(),t.getMonth()-1,t.getDate()).getTime();default:return 0}},toggleSort=e=>{j===e?w("desc"===N?"asc":"desc"):(v(e),w("desc"))},k=(0,a.useMemo)(()=>e.filter(e=>{if("all"!==m&&e.status!==m)return!1;if("all"!==p){let t=getDateRangeStart(p);if(e.createdAt<t)return!1}if(x){let t=x.toLowerCase(),l=e.id.toLowerCase().includes(t),a=(e.memberEmail||"").toLowerCase().includes(t),r=e.items.some(e=>{let l=s.find(t=>t.id===e.productId);return!!l&&(0,i.pC)(l,C).title.toLowerCase().includes(t)});if(!l&&!a&&!r)return!1}return!0}).sort((e,t)=>{if("date"===j)return"desc"===N?t.createdAt-e.createdAt:e.createdAt-t.createdAt;if("total"===j)return"desc"===N?t.total-e.total:e.total-t.total;let s=e.memberEmail||"",l=t.memberEmail||"";return"desc"===N?l.localeCompare(s):s.localeCompare(l)}),[e,m,p,x,j,N,s,C]),D=(0,a.useMemo)(()=>{let e=k.reduce((e,t)=>e+t.total,0),t=k.reduce((e,t)=>(e[t.status]=(e[t.status]||0)+1,e),{});return{total:e,counts:t}},[k]),onDelete=async e=>{confirm("آیا مطمئن هستید می‌خواهید این سفارش را حذف کنید؟")&&((0,d.deleteOrder)(e),t((0,d.loadOrders)()),S(t=>{let s=new Set(t);return s.delete(e),s}))},handleDeleteSelected=async()=>{if(!y.size||!confirm("آیا از حذف "+y.size+" سفارش انتخاب شده مطمئن هستید؟"))return;let s=e.filter(e=>!y.has(e.id));(0,d.saveOrders)(s),t(s),S(new Set)},handleSelectAll=e=>{e?S(new Set(k.map(e=>e.id))):S(new Set)},updateStatus=(s,l)=>{let a=e.map(e=>e.id===s?{...e,status:l}:e);try{localStorage.setItem("qanari:orders",JSON.stringify(a)),t(a)}catch(e){}},z={pending:"bg-yellow-100 text-yellow-800",paid:"bg-green-100 text-green-800",shipped:"bg-blue-100 text-blue-800",cancelled:"bg-red-100 text-red-800"};return(0,l.jsx)(r.Z,{children:(0,l.jsxs)("div",{className:"space-y-6",children:[(0,l.jsxs)("div",{className:"flex items-center justify-between",children:[(0,l.jsx)("h1",{className:"text-2xl font-bold",children:"مدیریت سفارش‌ها"}),(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsxs)("select",{value:p,onChange:e=>g(e.target.value),className:"px-3 py-2 border rounded text-sm",children:[(0,l.jsx)("option",{value:"all",children:"همه زمان‌ها"}),(0,l.jsx)("option",{value:"today",children:"امروز"}),(0,l.jsx)("option",{value:"week",children:"هفته اخیر"}),(0,l.jsx)("option",{value:"month",children:"ماه اخیر"})]}),y.size>0&&(0,l.jsxs)("button",{onClick:handleDeleteSelected,className:"px-3 py-2 border border-red-500 text-red-600 rounded hover:bg-red-50",children:["حذف ",y.size," سفارش"]})]})]}),(0,l.jsxs)("div",{className:"grid grid-cols-4 gap-4",children:[(0,l.jsxs)("div",{className:"bg-white p-4 rounded-lg shadow",children:[(0,l.jsx)("div",{className:"text-sm text-gray-500",children:"کل سفارش‌ها"}),(0,l.jsx)("div",{className:"text-2xl font-bold mt-1",children:k.length})]}),(0,l.jsxs)("div",{className:"bg-white p-4 rounded-lg shadow",children:[(0,l.jsx)("div",{className:"text-sm text-gray-500",children:"مجموع فروش"}),(0,l.jsxs)("div",{className:"text-2xl font-bold mt-1",children:[D.total.toLocaleString()," تومان"]})]}),(0,l.jsxs)("div",{className:"bg-white p-4 rounded-lg shadow",children:[(0,l.jsx)("div",{className:"text-sm text-gray-500",children:"در انتظار پرداخت"}),(0,l.jsx)("div",{className:"text-2xl font-bold mt-1",children:D.counts.pending||0})]}),(0,l.jsxs)("div",{className:"bg-white p-4 rounded-lg shadow",children:[(0,l.jsx)("div",{className:"text-sm text-gray-500",children:"تکمیل شده"}),(0,l.jsx)("div",{className:"text-2xl font-bold mt-1",children:D.counts.shipped||0})]})]}),(0,l.jsxs)("div",{className:"bg-white rounded-lg shadow",children:[(0,l.jsx)("div",{className:"p-4 border-b",children:(0,l.jsxs)("div",{className:"flex flex-wrap gap-4",children:[(0,l.jsx)("div",{className:"flex-1 min-w-[200px]",children:(0,l.jsx)("input",{value:x,onChange:e=>h(e.target.value),placeholder:"جستجو در شناسه، ایمیل یا محصولات...",className:"w-full px-3 py-2 border rounded"})}),(0,l.jsxs)("select",{value:m,onChange:e=>u(e.target.value),className:"px-3 py-2 border rounded",children:[(0,l.jsx)("option",{value:"all",children:"همه وضعیت‌ها"}),(0,l.jsx)("option",{value:"pending",children:"در انتظار پرداخت"}),(0,l.jsx)("option",{value:"paid",children:"پرداخت شده"}),(0,l.jsx)("option",{value:"shipped",children:"ارسال شده"}),(0,l.jsx)("option",{value:"cancelled",children:"لغو شده"})]})]})}),(0,l.jsx)("div",{className:"overflow-x-auto",children:(0,l.jsxs)("table",{className:"w-full",children:[(0,l.jsx)("thead",{className:"bg-gray-50",children:(0,l.jsxs)("tr",{children:[(0,l.jsx)("th",{className:"px-4 py-3 text-right",children:(0,l.jsx)("input",{type:"checkbox",checked:y.size>0&&y.size===k.length,onChange:e=>handleSelectAll(e.target.checked)})}),(0,l.jsx)("th",{className:"px-4 py-3 text-right",children:"شناسه"}),(0,l.jsxs)("th",{className:"px-4 py-3 text-right cursor-pointer hover:bg-gray-100",onClick:()=>toggleSort("email"),children:["مشتری","email"===j&&(0,l.jsx)("span",{className:"mr-1",children:"desc"===N?"▼":"▲"})]}),(0,l.jsxs)("th",{className:"px-4 py-3 text-right cursor-pointer hover:bg-gray-100",onClick:()=>toggleSort("total"),children:["مبلغ","total"===j&&(0,l.jsx)("span",{className:"mr-1",children:"desc"===N?"▼":"▲"})]}),(0,l.jsx)("th",{className:"px-4 py-3 text-right",children:"وضعیت"}),(0,l.jsxs)("th",{className:"px-4 py-3 text-right cursor-pointer hover:bg-gray-100",onClick:()=>toggleSort("date"),children:["تاریخ","date"===j&&(0,l.jsx)("span",{className:"mr-1",children:"desc"===N?"▼":"▲"})]}),(0,l.jsx)("th",{className:"px-4 py-3 text-right",children:"عملیات"})]})}),(0,l.jsxs)("tbody",{className:"divide-y",children:[k.map(e=>(0,l.jsxs)("tr",{className:"hover:bg-gray-50",children:[(0,l.jsx)("td",{className:"px-4 py-3",children:(0,l.jsx)("input",{type:"checkbox",checked:y.has(e.id),onChange:t=>{let s=new Set(y);t.target.checked?s.add(e.id):s.delete(e.id),S(s)}})}),(0,l.jsxs)("td",{className:"px-4 py-3",children:[(0,l.jsx)("div",{className:"font-medium",children:e.id}),(0,l.jsxs)("div",{className:"text-xs text-gray-500",children:[e.items.length," محصول"]})]}),(0,l.jsx)("td",{className:"px-4 py-3",children:(0,l.jsx)("div",{children:e.memberEmail||"مهمان"})}),(0,l.jsxs)("td",{className:"px-4 py-3 font-medium",children:[e.total.toLocaleString()," تومان"]}),(0,l.jsx)("td",{className:"px-4 py-3",children:(0,l.jsxs)("select",{value:e.status,onChange:t=>updateStatus(e.id,t.target.value),className:"px-2 py-1 rounded text-sm ".concat(z[e.status]),children:[(0,l.jsx)("option",{value:"pending",children:"در انتظار پرداخت"}),(0,l.jsx)("option",{value:"paid",children:"پرداخت شده"}),(0,l.jsx)("option",{value:"shipped",children:"ارسال شده"}),(0,l.jsx)("option",{value:"cancelled",children:"لغو شده"})]})}),(0,l.jsx)("td",{className:"px-4 py-3 text-sm text-gray-600",children:new Date(e.createdAt).toLocaleString()}),(0,l.jsx)("td",{className:"px-4 py-3",children:(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)("button",{onClick:()=>f(e),className:"text-blue-600 hover:text-blue-800",title:"نمایش فاکتور",children:(0,l.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:(0,l.jsx)("path",{fillRule:"evenodd",d:"M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 0v12h8V4H6z",clipRule:"evenodd"})})}),(0,l.jsx)("button",{onClick:()=>{let t=(0,d.reprocessSingleOrderForMetrics)(e.id);alert(JSON.stringify(t))},className:"text-gray-600 hover:text-gray-800",title:"بررسی متریک",children:(0,l.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:(0,l.jsx)("path",{d:"M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zm6-4a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zm6-3a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"})})}),(0,l.jsx)("button",{onClick:()=>onDelete(e.id),className:"text-red-600 hover:text-red-800",title:"حذف سفارش",children:(0,l.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:(0,l.jsx)("path",{fillRule:"evenodd",d:"M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})})})]})})]},e.id)),0===k.length&&(0,l.jsx)("tr",{children:(0,l.jsx)("td",{colSpan:7,className:"px-4 py-8 text-center text-gray-500",children:"هیچ سفارشی با این فیلترها پیدا نشد."})})]})]})})]}),b?(0,l.jsx)("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center",children:(0,l.jsxs)("div",{className:"bg-white p-4 rounded w-11/12 max-w-xl",children:[(0,l.jsxs)("h3",{className:"font-semibold mb-2",children:["فاکتور ",b.id]}),(0,l.jsxs)("div",{children:["تاریخ: ",new Date(b.createdAt).toLocaleString()]}),(0,l.jsxs)("div",{children:["ایمیل مشتری: ",b.memberEmail||"مهمان"]}),(0,l.jsx)("ul",{className:"list-disc ml-6 mt-2",children:b.items.map((e,t)=>(0,l.jsxs)("li",{children:[e.productId," \xd7 ",e.quantity]},t))}),(0,l.jsxs)("div",{className:"mt-2 font-semibold",children:["مجموع: ",b.total.toLocaleString()," تومان"]}),(0,l.jsxs)("div",{className:"mt-3 flex gap-2",children:[(0,l.jsx)("button",{className:"px-3 py-1 border rounded",onClick:()=>window.print(),children:"چاپ"}),(0,l.jsx)("button",{className:"px-3 py-1 border rounded",onClick:()=>f(null),children:"بستن"})]})]})}):null]})})}}},function(e){e.O(0,[424,675,774,888,179],function(){return e(e.s=2479)}),_N_E=e.O()}]);